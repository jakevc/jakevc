<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Intro to galaxy admin | Jake VanCampen</title>


<link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/syntax.css"><link rel='stylesheet' href='/css/custom.css'><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
<link rel="manifest" href="/favicon/site.webmanifest">
<link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#fffff">
<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="/"><h1 class="title is-4">Jake VanCampen</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" aria-label="email" href='mailto:jake.vancampen7@gmail.com' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="github" href='https://github.com/jakevc' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="linkedin" href='https://linkedin.com/in/jakevancampen' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/jake_vancampen' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
        <div class="nav-left"><a class="nav-item" href="/bio">
                <h2 class="title is-5">Bio</h2>
              </a><a class="nav-item" href="/cv">
                <h2 class="title is-5">CV</h2>
              </a></div>
      

      
    </nav>

  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/gccbosc">#gccbosc</a>



  
  | <a class="subtitle is-6" href="/tags/usegalaxy">#usegalaxy</a>
  
  | <a class="subtitle is-6" href="/tags/ansible">#ansible</a>
  

      
    </div>
    <h2 class="subtitle is-6">June 25, 2018</h2>
    
    <div class="content">
      

<h1 id="into-to-galaxy-admin-morning">Into to Galaxy Admin &ndash; Morning</h1>

<h2 id="using-ansible-to-setup-a-galaxy">Using Ansible to setup a Galaxy</h2>

<p>Ansible is an automated computer management system that can be used to install and configure software infastructure. Ansible scripts are called playbooks, written as yaml files, can be structured in folder hierarchy with mnay available modules.</p>

<p>Why:
  - avoid forgetting what you did to install and configure some software
  - codify knowledge about system
  - &ldquo;make infastructure programmable&rdquo;</p>

<p>Ansible features:
  - easy to learn (YAML playbooks, jinja2 templates, INI inventory )
  - sequential execution</p>

<h2 id="install-galaxy-with-ansible">Install Galaxy with ansible:</h2>

<p>Exercise using ansible to install Galaxy <a href="https://github.com/galaxyproject/dagobah-training/blob/2018-gccbosc/sessions/14-ansible/ex2-galaxy-ansible.md" target="_blank">here</a>.</p>

<p>Install the GalaxyKickStart (GKS) playbook onto a server or VM by cloning the repo, and installing using the requirements_roles.yml. The GKS playbook is a pre-configured playbook for configuration of an operating-system independent, standard galaxy server.</p>
<div class="highlight"><pre class="chroma">sudo pip install ansible
git clone https://github.com/ARTbio/GalaxyKickStart
cd GalaxyKickStart
git checkout 2018-gccbosc
# install all dependent roles
ansible-galaxy install -r requirements_roles.yml -p roles --force</pre></div>
<p>You will see output similar to the following:</p>
<div class="highlight"><pre class="chroma"><span class="nx">TASK</span> <span class="p">[</span><span class="nx">galaxyprojectdotorg</span><span class="p">.</span><span class="nx">galaxy</span><span class="o">-</span><span class="nx">extras</span> <span class="p">:</span> <span class="nx">Yarn</span><span class="p">:</span> <span class="nx">Make</span> <span class="nx">sure</span> <span class="kn">package</span> <span class="nx">key</span> <span class="nx">is</span> <span class="nx">present</span><span class="p">]</span> <span class="o">***</span>
<span class="nx">changed</span><span class="p">:</span> <span class="p">[</span><span class="nx">localhost</span><span class="p">]</span>

<span class="nx">TASK</span> <span class="p">[</span><span class="nx">galaxyprojectdotorg</span><span class="p">.</span><span class="nx">galaxy</span><span class="o">-</span><span class="nx">extras</span> <span class="p">:</span> <span class="nx">Yarn</span><span class="p">:</span> <span class="nx">Add</span> <span class="nx">Debian</span><span class="o">/</span><span class="nx">Ubuntu</span> <span class="kn">package</span> <span class="nx">to</span> <span class="nx">sources</span> <span class="nx">list</span><span class="p">]</span> <span class="o">***</span>
<span class="nx">changed</span><span class="p">:</span> <span class="p">[</span><span class="nx">localhost</span><span class="p">]</span>

<span class="nx">TASK</span> <span class="p">[</span><span class="nx">galaxyprojectdotorg</span><span class="p">.</span><span class="nx">galaxy</span><span class="o">-</span><span class="nx">extras</span> <span class="p">:</span> <span class="nx">Yarn</span><span class="p">:</span> <span class="nx">Install</span><span class="p">]</span> <span class="o">***********************</span>
<span class="nx">changed</span><span class="p">:</span> <span class="p">[</span><span class="nx">localhost</span><span class="p">]</span>

<span class="nx">RUNNING</span> <span class="nx">HANDLER</span> <span class="p">[</span><span class="nx">galaxyprojectdotorg</span><span class="p">.</span><span class="nx">galaxy</span><span class="o">-</span><span class="nx">extras</span> <span class="p">:</span> <span class="nx">restart</span> <span class="nx">nginx</span><span class="p">]</span> <span class="o">************</span>
<span class="nx">changed</span><span class="p">:</span> <span class="p">[</span><span class="nx">localhost</span><span class="p">]</span>

<span class="nx">TASK</span> <span class="p">[</span><span class="nx">galaxyprojectdotorg</span><span class="p">.</span><span class="nx">galaxy</span><span class="o">-</span><span class="nx">tools</span> <span class="p">:</span> <span class="nx">include</span><span class="p">]</span> <span class="o">******************************</span>

<span class="nx">PLAY</span> <span class="nx">RECAP</span> <span class="o">*********************************************************************</span>
<span class="nx">localhost</span>                  <span class="p">:</span> <span class="nx">ok</span><span class="p">=</span><span class="mi">119</span>  <span class="nx">changed</span><span class="p">=</span><span class="mi">95</span>   <span class="nx">unreachable</span><span class="p">=</span><span class="mi">0</span>    <span class="nx">failed</span><span class="p">=</span><span class="mi">0</span>   </pre></div>
<p>Taking a look at the playbook <code>galaxy.yml</code> we see it contains many roles that sequentially execute to produce the desired structure. We can make our own set of variables in <code>group_vars/gccbosc18.yml</code>, only including those variables that will override the default values of <code>group_vars/all</code>.  E.g.</p>
<div class="highlight"><pre class="chroma">galaxy_root_dir: /srv/galaxy
galaxy_server_dir: &#34;{{ galaxy_root_dir }}/server&#34;
galaxy_venv_dir: &#34;{{ galaxy_root_dir }}/venv&#34;
galaxy_mutable_data_dir: &#34;{{ galaxy_data }}&#34;
proftpd_files_dir: &#34;{{ galaxy_data }}/ftp&#34;
galaxy_config_dir: &#34;{{ galaxy_root_dir }}/config&#34;
galaxy_mutable_config_dir: &#34;{{ galaxy_config_dir }}&#34;
galaxy_shed_tools_dir: &#34;{{ galaxy_root_dir }}/shed_tools&#34;
galaxy_tool_dependency_dir: &#34;{{ galaxy_root_dir }}/dependencies&#34;
tool_dependency_dir: &#34;{{ galaxy_tool_dependency_dir }}&#34;
galaxy_job_conf_path: &#34;{{ galaxy_config_dir }}/job_conf.xml&#34;
galaxy_job_metrics_conf_path: &#34;{{ galaxy_config_dir }}/job_metrics_conf.xml&#34;
nginx_upload_store_path: &#34;{{ galaxy_data }}/upload_store&#34;
tool_data_table_config_path: &#34;{{ galaxy_config_dir }}/tool_data_table_conf.xml,/cvmfs/data.galaxyproject.org/managed/location/tool_data_table_conf.xml&#34;
len_file_path: &#34;{{ galaxy_config_dir }}/len&#34;
galaxy_log_dir: &#34;{{ galaxy_root_dir }}/log&#34;
supervisor_slurm_config_dir: &#34;{{ galaxy_log_dir }}&#34;

galaxy_manage_trackster: False
galaxy_extras_config_cvmfs: True
galaxy_restart_handler_enabled: True
galaxy_mule_handlers: True
galaxy_handler_processes: 1

galaxy_config_style: yaml
galaxy_config_file: &#34;{{ galaxy_config_dir }}/galaxy.yml&#34;

galaxy_config:
  galaxy:
    database_connection: &#34;{{ galaxy_db }}&#34;
    file_path: &#34;{{ galaxy_data }}/datasets&#34;
    new_file_path: &#34;{{ galaxy_data }}/tmp&#34;
    galaxy_data_manager_data_path: &#34;{{ galaxy_data }}/tool-data&#34;
    job_config_file: &#34;{{ galaxy_job_conf_path }}&#34;
    ftp_upload_dir: &#34;{{ proftpd_files_dir }}&#34;
    ftp_upload_site: ftp://[server IP address]
    tool_data_table_config_path: &#34;{{ tool_data_table_config_path }}&#34;
    len_file_path: &#34;{{ len_file_path }}&#34;
    check_migrate_tools: False
  uwsgi:
    module: galaxy.webapps.galaxy.buildapp:uwsgi_app()
    logfile-chmod: 644


additional_files_list:
  - { src: &#34;extra-files/galaxy-kickstart/logo.png&#34;, dest: &#34;{{ galaxy_server_dir }}/static/images/&#34; }
  - { src: &#34;extra-files/tool_sheds_conf.xml&#34;, dest: &#34;{{ galaxy_config_dir }}&#34; }
  - { src: &#34;extra-files/cloud_setup/vimrc&#34;, dest: &#34;/etc/vim/&#34; }</pre></div>
<p>Then add the following code-chunk to the end of the <code>pre-tasks</code> section of the playbook in the toplevel <code>galaxy.yml</code>.</p>
<div class="highlight"><pre class="chroma">  - name: Create galaxy system user
      user:
        name: &#34;galaxy&#34;
        home: &#34;/srv/galaxy&#34;
        skeleton: &#34;/etc/skel&#34;
        shell: &#34;/bin/bash&#34;
        system: yes
      tags:
          - always</pre></div>
<p>This creates the local system user. Then the follwoing lines were added to a new inventory file:</p>
<div class="highlight"><pre class="chroma">[gccbosc18]
localhost ansible_connection=local</pre></div>
<p>Now running <code>ansible-playbook -i inventory galaxy.yml --tags &quot;install_galaxy,install_extras&quot;</code> will run the playbook and install everything in it&rsquo;s desired locaiton (~20min).</p>

<ul>
<li><code>sudo supervisorctl status</code> lists all programs</li>
<li><code>sudo supervisorctl restart galaxy:</code> restarts the server with new variables if anything is changed in <code>/srv/galaxy/config/</code>.
<br /></li>
</ul>

<p>You can add yourself as a user, so you see an Admin tab on your running server:</p>
<div class="highlight"><pre class="chroma">$ sudo su galaxy
$ vi /srv/galaxy/config/galaxy.yml
# Add the following line under galaxy: section
    admin_users: your@email.address
$ exit  # change back to ubuntu user
$ sudo supervisorctl restart galaxy:</pre></div>
<p>Determine what is running:</p>
<div class="highlight"><pre class="chroma">ubuntu@2018-gcc-training-42:~/GalaxyKickStart$ sinfo
PARTITION AVAIL  TIMELIMIT  NODES  STATE NODELIST
debug*       up   infinite      1   idle 2018-gcc-training-42
ubuntu@2018-gcc-training-42:~/GalaxyKickStart$ sudo supervisorctl status 
autofs                           RUNNING   pid 3611, uptime 0:03:18
cron                             STOPPED   Not started
galaxy:galaxy_web                RUNNING   pid 3612, uptime 0:03:18
munge                            RUNNING   pid 3604, uptime 0:03:18
nginx                            RUNNING   pid 3606, uptime 0:03:18
postgresql                       RUNNING   pid 3602, uptime 0:03:18
pre_postgresql                   EXITED    Jun 25 05:22 PM
proftpd                          RUNNING   pid 3610, uptime 0:03:18
reports                          STOPPED   Not started
slurmctld                        RUNNING   pid 3605, uptime 0:03:18
slurmd                           RUNNING   pid 3607, uptime 0:03:18
ubuntu@2018-gcc-training-42:~/GalaxyKickStart$ </pre></div>
<p>More about galaxy and ansible is found by searching ansible on the galaxy <a href="https://github.com/galaxyproject" target="_blank">github</a>.</p>

<p>Summary:</p>

<p>Galaxy setup can be continerized and reprodicible. Ansible provides the tools to be able to write your setup as a recipe, and easily manage config in YAML format.</p>

<p>More:
  <a href="https://github.com/galaxyproject/dagobah-training/blob/2018-gccbosc/sessions/06-extending-installation/ex1-proftpd.md" target="_blank">Configure FTP upload</a> |
  <a href="https://github.com/galaxyproject/dagobah-training/blob/2018-gccbosc/sessions/05-reference-genomes/ex1-reference-genomes.md#exercise-3-install-a-datamanager-from-the-toolshed" target="_blank">Reference data and Data Managers</a></p>

<h1 id="intro-to-galaxy-admin-noon">Intro to Galaxy Admin &ndash; Noon</h1>

<h2 id="building-galaxy-tools-with-planemo">Building Galaxy tools with planemo</h2>

<p>Planemo provides useful tools for testing and writing galaxy tools, a tutorial for writing a basic galaxy tools using a template can be found on the Planemo <a href="http://planemo.readthedocs.io/en/latest/writing_standalone.html" target="_blank">documenation</a>.</p>

<p>In summary: The command <code>planemo tool_init</code> takes a variety of flags to auto-generate boilerplate XML for tool generation, tool files are just XML configuration files. Useful flags include <code>--example_command</code>, <code>--example_output</code>, and <code>--example_input</code>; passing values to these parameters includes them in the XML tool file.</p>

<p>Once the tools is built out well, you can test the validity of the tool file by panemo lint: <code>planemo l [tool.xml]</code>. The tool can be tested using plantemo test: <code>planemo t [tool.xml]</code>, will output if the test passed or failed. Then you can <strong>serve</strong> the new tool to Galaxy to view it <code>planemo s</code>. There are many more ways to tweak the tool XML for additional functionality such as wrapping custom scripts. Planemo provides a nice way to establish a tool development workflow, if that&rsquo;s what you are into.</p>

<h2 id="run-tools-in-containers">Run tools in containers</h2>

<p>If your Galaxy install already has a local Docker image you can instruct a tool to be run in a container by setting it&rsquo;s destination as docker in <code>/srv/galaxy/config/job_conf.xml</code>:</p>
<div class="highlight"><pre class="chroma">&lt;tools&gt;
   &lt;tool id=&#34;jq&#34; destination=&#34;local_docker&#34;/&gt;
&lt;/tools&gt;</pre></div>
<p>You must also enable containers in <code>galaxy.yml</code>:</p>
<div class="highlight"><pre class="chroma">galaxy:
    enable_beta_mulled_containers: true</pre></div>
<p>, and make sure that the correct docker image has been pulled in this case for the <code>jq</code> tool:</p>
<div class="highlight"><pre class="chroma">$ sudo docker images
REPOSITORY                 TAG                 IMAGE ID            CREATED             SIZE
quay.io/biocontainers/jq   1.5--4              1fe0f3d31487        7 weeks ago         15.6MB</pre></div>
<h1 id="intro-to-galaxy-admin-afternoon">Intro to Galaxy Admin &ndash; Afternoon</h1>

<h2 id="send-tool-jobs-to-compute-cluster">Send tool jobs to compute cluster</h2>

<p>Galaxy can be setup to send jobs to SLURM, instructions for the setup are at the top of this <a href="http://galaxyproject.github.io/training-material/topics/admin/tutorials/connect-to-compute-cluster/tutorial.html" target="_blank">document</a>. Once that is setup, tools can be configured to use multiple cores by editing the tool configuration file <code>/srv/galaxy/config/tool_conf.xml</code>. You have to make sure galaxy knows which tool config file you are using by editing the <code>/srv/galaxy/config/galaxy.yml</code> to include the correct path:</p>
<div class="highlight"><pre class="chroma">galaxy:
    tool_config_file: /srv/galaxy/config/tool_conf.xml,/srv/galaxy/config/shed_tool_conf.xml</pre></div>
<p>You can specify destinations to map tools to in <code>tool_conf.xml</code>, for example, a slurm destnation:</p>
<div class="highlight"><pre class="chroma">&lt;destination id=&#34;slurm-2c&#34; runner=&#34;slurm&#34;&gt;
    &lt;param id=&#34;nativeSpecification&#34;&gt;--nodes=1 --ntasks=2&lt;/param&gt;
&lt;/destination&gt;</pre></div>
<p>Then map the tool to this destination in the same file by:</p>
<div class="highlight"><pre class="chroma">&lt;tools&gt;
   &lt;tool id=[tool id] destination=&#34;slurm-2c&#34;/&gt;
&lt;/tools&gt;</pre></div>
<p>You can also specify dynamic tool destinations by creating a <code>/srv/galaxy/config/tool_destinations.yml</code>. This file allows you to specify dynamic destinations, for example if the dataset is greater than a certain size, send to multi-core destination, else send to single-core destination.</p>

<h2 id="expanding-galaxy-file-space">Expanding galaxy file space</h2>

<p><a href="https://github.com/galaxyproject/dagobah-training/blob/2018-gccbosc/sessions/19-storage/ex1-objectstore.md#section-1---hierarchical-object-store" target="_blank">Hierarchical Object storage</a> allows you direct newer datasets to a different place on disk by creating and <code>object_store_config.xml</code> that is pointed to in <code>galaxy.yml</code>.</p>

<p><a href="https://github.com/galaxyproject/dagobah-training/blob/2018-gccbosc/sessions/19-storage/ex1-objectstore.md#section-2---distributed-object-store" target="_blank">Distributed Object storage</a> could instead be used to defer datsets to different locations with different weights, for example you can configure a <code>newdata</code> location to get 3 times more than an <code>newnewdata</code> location.</p>

<h1 id="end">End</h1>

<p>The full training course for galaxy admin, and other galaxy training can be found at:</p>

<ul>
<li><a href="https://github.com/galaxyproject/dagobah-training" target="_blank">dagobah training</a></li>
<li><a href="https://galaxyproject.github.io/training-material/" target="_blank">galaxy training</a></li>
</ul>

      
      <div class="related">
</div>
      
    </div>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'jakevc';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p></p>
    
  </div>
</section>

<script src="//yihui.name/js/math-code.js"></script>
<script async
src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


</body>
</html>

